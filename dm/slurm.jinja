# Copyright 2017 SchedMD LLC.
# Modified for use with the Slurm Resource Manager.
#
# Copyright 2015 Google Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{% set _ = properties.update({
    'project': env['project'],
    'compute_node_prefix': properties['cluster_name'] ~ '-compute',
    }) %}
{% set cluster_region =  '-'.join(properties['zone'].split('-')[:-1]) %}
{% set project = properties['project'] %}
{% set zone = properties['zone'] %}
{% set vpc_net = properties['vpc_net'] %}
{% set vpc_subnet = properties['vpc_subnet'] %}
{% set cluster_name = properties['cluster_name'] %}

resources:
- name: {{cluster_name}}-router
  type: compute.v1.router
  properties:
    network: https://www.googleapis.com/compute/v1/projects/{{project}}/global/networks/{{vpc_net}}
    region: {{cluster_region}}
    nats:
    - name: {{cluster_name}}-nat
      natIpAllocateOption: "AUTO_ONLY"
      sourceSubnetworkIpRangesToNat: "LIST_OF_SUBNETWORKS"
      subnetworks:
      - name: https://www.googleapis.com/compute/v1/projects/{{project}}/regions/{{cluster_region}}/subnetworks/{{vpc_subnet}}
        sourceIpRangesToNat: ["PRIMARY_IP_RANGE"]


- name: {{cluster_name}}-controller
  type: compute.v1.instance
  properties:
    zone: {{zone}}
    machineType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/machineTypes/{{properties["controller_machine_type"]}}
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        sourceImage: {{ properties['controller_image'] }}
        diskType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/diskTypes/{{properties["controller_disk_type"]}}
        diskSizeGb: {{properties["controller_disk_size_gb"]}}
{% if properties['controller_secondary_disk'] %}
    - deviceName: secondary
      type: PERSISTENT
      autoDelete: TRUE
      initializeParams:
        diskType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/diskTypes/{{properties["controller_secondary_disk_type"]}}
        diskSizeGb: {{properties["controller_secondary_disk_size_gb"]}}
{% endif %}
    networkInterfaces:
    - subnetwork: https://www.googleapis.com/compute/v1/projects/{{project}}/regions/{{cluster_region}}/subnetworks/{{vpc_subnet}}
{% if properties['external_controller_ip'] %}
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
{% endif %}
    serviceAccounts:
      - email: {{properties["controller_service_account"]}}
        scopes: {{properties["controller_scopes"]}}
    tags:
      items:
        - controller
{% if properties["controller_labels"] %}
    labels:
      {{properties["controller_labels"]}}
{% endif %}
    metadata:
      items:
        - key: startup-script
          value: |
            {{ imports["../scripts/startup.sh"]|indent(12) }}
        - key: util-script
          value: |
            {{ imports["../scripts/util.py"]|indent(12) }}
        - key: config
          value: |
            {{ properties|safe|tojson(2)|indent(12) }}
        - key: setup-script
          value: |
            {{ imports["../scripts/setup.py"]|indent(12) }}
        - key: slurm-resume
          value: |
            {{ imports["../scripts/resume.py"]|indent(12) }}
        - key: slurm-suspend
          value: |
            {{ imports["../scripts/suspend.py"]|indent(12) }}
        - key: slurmsync
          value: |
            {{ imports["../scripts/slurmsync.py"]|indent(12) }}
        - key: enable-oslogin
          value: "TRUE"
        - key: VmDnsSetting
          value: GlobalOnly
        - key: custom-compute-install
          value: |
            {{ imports["../scripts/custom-compute-install"]|indent(12) }}
        - key: custom-controller-install
          value: |
            {{ imports["../scripts/custom-controller-install"]|indent(12) }}
        - key: compute-shutdown
          value: |
            {{ imports["../scripts/compute-shutdown"]|indent(12) }}
        - key: slurm_conf_tpl
          value: |
            {{ imports["../etc/slurm.conf.tpl"]|indent(12) }}
        - key: slurmdbd_conf_tpl
          value: |
            {{ imports["../etc/slurmdbd.conf.tpl"]|indent(12) }}
        - key: cgroup_conf_tpl
          value: |
            {{ imports["../etc/cgroup.conf.tpl"]|indent(12) }}
        - key: fluentd_conf_tpl
          value: |
            {{ imports["../etc/controller-fluentd.conf.tpl"]|indent(12) }}


{% for n in range(properties['login_node_count']) %}
- name: {{properties["cluster_name"]}}-login{{n}}
  type: compute.v1.instance
  properties:
    zone: {{zone}}
    machineType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/machineTypes/{{properties["login_machine_type"]}}
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        sourceImage: {{ properties['login_image'] }}
        diskType: https://www.googleapis.com/compute/v1/projects/{{properties["project"]}}/zones/{{zone}}/diskTypes/{{properties["login_disk_type"]}}
        diskSizeGb: {{properties["login_disk_size_gb"]}}
    networkInterfaces:
    - subnetwork: https://www.googleapis.com/compute/v1/projects/{{project}}/regions/{{cluster_region}}/subnetworks/{{vpc_subnet}}
{% if properties['external_login_ips'] %}
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
{% endif %}
    serviceAccounts:
      - email: {{properties["login_node_service_account"]}}
        scopes:
          {{properties["login_node_scopes"]}}
    tags:
      items:
        - login
  {% if properties["login_labels"] %}
    labels:
      {{properties["login_labels"]}}
  {% endif %}
    metadata:
      items:
        - key: startup-script
          value: |
            {{ imports["../scripts/startup.sh"]|indent(12) }}
        - key: util-script
          value: |
            {{ imports["../scripts/util.py"]|indent(12) }}
        - key: config
          value: |
            {{ properties|safe|tojson(2)|indent(12) }}
        - key: setup-script
          value: |
            {{ imports["../scripts/setup.py"]|indent(12) }}
        - key: enable-oslogin
          value: "TRUE"
        - key: VmDnsSetting
          value: GlobalOnly
{% endfor %}

{% for i in range(properties["partitions"]|length) %}
{% for n in range(properties["partitions"][i]['static_node_count']) %}
- name: {{properties["compute_node_prefix"]}}-{{i}}-{{n}}
  type: compute.v1.instance
  properties:
    zone: {{zone}}
    machineType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/machineTypes/{{properties['partitions'][i]['machine_type']}}
  {% if properties['partitions'][i]['cpu_platform'] %}
    minCpuPlatform: {{properties['partitions'][i]['cpu_platform']}}
  {% endif %}
  {% if properties['partitions'][i]['gpu_type'] %}
    guestAccelerators:
    - acceleratorType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/acceleratorTypes/{{properties['partitions'][i]['gpu_type']}}
      acceleratorCount: {{properties['partitions'][i]['gpu_count']}}
    scheduling:
      onHostMaintenance: TERMINATE
  {% endif %}
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        sourceImage: {{ properties['partitions'][i]['image'] }}
        diskType: https://www.googleapis.com/compute/v1/projects/{{project}}/zones/{{zone}}/diskTypes/{{properties["partitions"][i]["compute_disk_type"]}}
        diskSizeGb: {{ properties['partitions'][i]['compute_disk_size_gb'] }}
    networkInterfaces:
    - subnetwork: https://www.googleapis.com/compute/v1/projects/{{project}}/regions/{{cluster_region}}/subnetworks/{{properties['partitions'][i]['vpc_subnet']}}
  {% if properties['external_compute_ips'] %}
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
  {% endif %}
    serviceAccounts:
      - email: {{properties["compute_node_service_account"]}}
        scopes:
          {{properties["compute_node_scopes"]}}
    tags:
      items:
        - compute
  {% if properties["partitions"][i]["compute_labels"] %}
    labels:
      {{properties["partitions"][i]["compute_labels"]}}
  {% endif %}
    metadata:
      items:
        - key: startup-script
          value: |
            {{ imports["../scripts/startup.sh"]|indent(12) }}
        - key: util-script
          value: |
            {{ imports["../scripts/util.py"]|indent(12) }}
        - key: config
          value: |
            {{ properties|safe|tojson(2)|indent(12) }}
        - key: setup-script
          value: |
            {{ imports["../scripts/setup.py"]|indent(12) }}
        - key: enable-oslogin
          value: "TRUE"
        - key: VmDnsSetting
          value: GlobalOnly
        - key: fluentd_conf_tpl
          value: |
            {{ imports["../etc/compute-fluentd.conf.tpl"]|indent(12) }}
{% endfor %}
{% endfor %}
